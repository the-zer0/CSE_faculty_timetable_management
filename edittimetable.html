<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Faculty Timetable</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f7fa; margin:0; padding:20px; }
    .container { max-width:1200px; margin:auto; background:#fff; padding:30px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.1); }
    h1 { text-align:center; color:#2c3e50; margin-bottom:20px; }
    label { font-weight:600; color:#2c3e50; display:block; margin-bottom:8px; }
    select, input { width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; margin-bottom:15px; }
    .timetable-grid { display:grid; grid-template-columns:120px repeat(6,1fr); gap:8px; margin-top:20px; }
    .grid-header { background:#2c3e50; color:#fff; padding:10px; text-align:center; border-radius:4px; }
    .row-label { background:#34495e; color:#fff; padding:10px; text-align:center; border-radius:4px; }
    .grid-cell { position:relative; padding:10px; border:1px solid #ddd; border-radius:4px; min-height:80px; background:#f9f9f9; cursor:pointer; }
    .grid-cell.class { background:#e8f5e9; border-color:#2ecc71; }
    .grid-cell.leisure { background:#fdfdfd; }
    .delete-btn { position:absolute; top:4px; right:4px; background:#e74c3c; color:#fff; border:none; border-radius:50%; width:20px; height:20px; font-size:12px; line-height:18px; cursor:pointer; display:none; }
    .grid-cell.class .delete-btn { display:block; }
    .btn { padding:10px 18px; margin:5px; border:none; border-radius:4px; font-size:14px; cursor:pointer; }
    .btn-save { background:#3498db; color:white; }
    .btn-delete { background:#e74c3c; color:white; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    .modal-content { position:relative; background:#fff; padding:20px; border-radius:8px; width:400px; }
    .modal-close { position:absolute; top:8px; right:12px; font-size:22px; font-weight:bold; color:#333; cursor:pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Edit Faculty Timetable</h1>

    <label for="facultySelect">Select Faculty:</label>
    <select id="facultySelect"></select>

    <div class="timetable-grid" id="timetableGrid"></div>

    <div style="text-align:center;">
      <button class="btn btn-save" id="saveBtn">Save Changes</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="classModal">
    <div class="modal-content">
      <span class="modal-close" id="closeModal">&times;</span>
      <h3>Edit Class</h3>
      <label for="subject">Subject:</label>
      <input type="text" id="subject">
      <label for="classroom">Classroom:</label>
      <input type="text" id="classroom">
      <div style="margin-top:10px; text-align:right;">
        <button class="btn btn-delete" id="deleteModal">Delete</button>
        <button class="btn btn-save" id="saveModal">Save</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js';

    const SUPABASE_URL = 'https://ucihhvycupjjkmazpfby.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjaWhodnljdXBqamttYXpwZmJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxODQ5MjcsImV4cCI6MjA3Mzc2MDkyN30.XeWpXOmiZS1Z8ejDfnNZ89NiIBoDKTgogOeNDg-Rv8A'; // ðŸ”‘ replace with your Supabase anon key
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const facultySelect = document.getElementById('facultySelect');
    const timetableGrid = document.getElementById('timetableGrid');
    const saveBtn = document.getElementById('saveBtn');
    const classModal = document.getElementById('classModal');
    const subjectInput = document.getElementById('subject');
    const classroomInput = document.getElementById('classroom');
    const saveModal = document.getElementById('saveModal');
    const deleteModal = document.getElementById('deleteModal');
    const closeModal = document.getElementById('closeModal');

    let currentFaculty = null;
    let timetableData = [];
    let currentCell = null;

    const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

    // Build empty grid (Periods â†’ columns, Days â†’ rows)
    function buildGrid() {
      timetableGrid.innerHTML = `
        <div class="grid-header">Day/Period</div>
        ${[1,2,3,4,5,6].map(p => `<div class="grid-header">Period ${p}</div>`).join('')}
      `;
      for (let d = 1; d <= 6; d++) {
        timetableGrid.innerHTML += `<div class="row-label">${days[d-1]}</div>`;
        for (let p = 1; p <= 6; p++) {
          timetableGrid.innerHTML += `
            <div class="grid-cell leisure" data-day="${d}" data-period="${p}">
              <button class="delete-btn">Ã—</button>
            </div>`;
        }
      }
    }

    // Load faculty list
    async function loadFacultyList() {
      const { data, error } = await supabase.from('timetable').select('faculty_name');
      if (error) {
        console.error(error);
        facultySelect.innerHTML = '<option value="">Error loading faculty</option>';
        return;
      }
      const unique = [...new Set(data.map(d => d.faculty_name).filter(name => !!name))];
      if (unique.length === 0) {
        facultySelect.innerHTML = '<option value="">No faculty found</option>';
        return;
      }
      facultySelect.innerHTML =
        `<option value="">--Select Faculty--</option>` +
        unique.map(name => `<option value="${name}">${name}</option>`).join('');
    }

    // Load timetable for selected faculty
    async function loadFacultyTimetable(name) {
      const { data, error } = await supabase.from('timetable').select('*').eq('faculty_name', name);
      if (error) { console.error(error); return; }
      timetableData = data.map(d => ({ ...d }));
      renderTimetable();
    }

    // Render timetable
    function renderTimetable() {
      buildGrid();
      timetableData.forEach(entry => {
        const cell = timetableGrid.querySelector(`.grid-cell[data-day="${entry.day_id}"][data-period="${entry.period_id}"]`);
        if (!entry.is_leisure && entry.subject) {
          cell.classList.add('class');
          cell.classList.remove('leisure');
          cell.innerHTML = `<strong>${entry.subject}</strong><br>${entry.classroom || ''}<button class="delete-btn">Ã—</button>`;
        }
      });

      // Add delete listeners for grid cells
      timetableGrid.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const cell = btn.parentElement;
          const day = cell.dataset.day;
          const period = cell.dataset.period;
          const entry = timetableData.find(x => x.day_id == day && x.period_id == period);
          entry.subject = null;
          entry.classroom = null;
          entry.is_leisure = true;
          renderTimetable();
        });
      });
    }

    // Cell click â†’ open modal
    timetableGrid.addEventListener('click', e => {
      if (!e.target.classList.contains('grid-cell')) return;
      currentCell = e.target;
      const day = currentCell.dataset.day;
      const period = currentCell.dataset.period;
      const entry = timetableData.find(x => x.day_id == day && x.period_id == period);
      subjectInput.value = entry?.subject || '';
      classroomInput.value = entry?.classroom || '';
      classModal.style.display = 'flex';
    });

    // Save in modal
    saveModal.addEventListener('click', () => {
      if (!currentCell) return;
      const day = currentCell.dataset.day;
      const period = currentCell.dataset.period;
      const entry = timetableData.find(x => x.day_id == day && x.period_id == period);
      entry.subject = subjectInput.value.trim();
      entry.classroom = entry.subject ? classroomInput.value.trim() : null;
      entry.is_leisure = entry.subject === '';
      renderTimetable();
      classModal.style.display = 'none';
    });

    // Delete in modal
    deleteModal.addEventListener('click', () => {
      if (!currentCell) return;
      const day = currentCell.dataset.day;
      const period = currentCell.dataset.period;
      const entry = timetableData.find(x => x.day_id == day && x.period_id == period);
      entry.subject = null;
      entry.classroom = null;
      entry.is_leisure = true;
      renderTimetable();
      classModal.style.display = 'none';
    });

    // Close modal (X button)
    closeModal.addEventListener('click', () => {
      classModal.style.display = 'none';
    });

    // Close modal when clicking outside content
    window.addEventListener('click', (e) => {
      if (e.target === classModal) {
        classModal.style.display = 'none';
      }
    });

    // Save to DB
    saveBtn.addEventListener('click', async () => {
      if (!currentFaculty) { alert('Select faculty first'); return; }
      const rows = timetableData.map(item => ({
        faculty_name: item.faculty_name,
        day_id: item.day_id,
        period_id: item.period_id,
        subject: item.is_leisure ? null : item.subject,
        classroom: item.is_leisure ? null : item.classroom,
        is_leisure: item.is_leisure
      }));
      const { error } = await supabase.from('timetable').upsert(rows, { onConflict: ['faculty_name','day_id','period_id'] });
      if (error) alert('Error saving: ' + error.message);
      else alert('Timetable updated successfully!');
    });

    // Faculty selection
    facultySelect.addEventListener('change', e => {
      currentFaculty = e.target.value;
      if (currentFaculty) loadFacultyTimetable(currentFaculty);
    });

    // Init
    buildGrid();
    loadFacultyList();
  </script>
  <script>
    if (!localStorage.getItem("loggedIn")) {
      window.location.href = "login.html";
    }
  </script>
</body>
</html>
