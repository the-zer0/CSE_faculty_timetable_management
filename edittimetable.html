<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Faculty Timetable</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f7fa; margin:0; padding:20px; }
    .container { max-width:1200px; margin:auto; background:#fff; padding:30px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.1); }
    h1 { text-align:center; color:#2c3e50; margin-bottom:20px; }
    label { font-weight:600; color:#2c3e50; display:block; margin-bottom:8px; }
    select, input { width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; margin-bottom:15px; }
    .timetable-grid { display:grid; grid-template-columns:120px repeat(6,1fr); gap:8px; margin-top:20px; }
    .grid-header { background:#2c3e50; color:#fff; padding:10px; text-align:center; border-radius:4px; }
    .row-label { background:#34495e; color:#fff; padding:10px; text-align:center; border-radius:4px; }
    .grid-cell { position:relative; padding:10px; border:1px solid #ddd; border-radius:4px; min-height:80px; background:#f9f9f9; cursor:pointer; }
    .grid-cell.class { background:#e8f5e9; border-color:#2ecc71; }
    .grid-cell.leisure { background:#fdfdfd; }
    .delete-btn { position:absolute; top:4px; right:4px; background:#e74c3c; color:#fff; border:none; border-radius:50%; width:20px; height:20px; font-size:12px; line-height:18px; cursor:pointer; display:none; }
    .grid-cell.class .delete-btn { display:block; }
    .btn { padding:10px 18px; margin:5px; border:none; border-radius:4px; font-size:14px; cursor:pointer; }
    .btn-save { background:#3498db; color:white; }
    .btn-delete { background:#e74c3c; color:white; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    .modal-content { position:relative; background:#fff; padding:20px; border-radius:8px; width:400px; }
    .modal-close { position:absolute; top:8px; right:12px; font-size:22px; font-weight:bold; color:#333; cursor:pointer; }
    .selection-container { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }
    .search-container { position:relative; }
    .search-results { position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ddd; border-radius:4px; max-height:200px; overflow-y:auto; z-index:1000; display:none; }
    .search-result-item { padding:10px; cursor:pointer; border-bottom:1px solid #eee; }
    .search-result-item:hover { background:#f0f0f0; }
    .search-result-item:last-child { border-bottom:none; }
    .current-faculty { margin:10px 0; padding:15px; background:#e8f4fd; border-radius:4px; font-weight:bold; text-align:center; }
    .faculty-stats { margin-bottom:15px; padding:10px; background:#f8f9fa; border-radius:4px; text-align:center; font-size:14px; color:#666; }
    .loading { color: #666; font-style: italic; }
    @media (max-width: 768px) {
      .selection-container { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Edit Faculty Timetable</h1>

    <div class="faculty-stats" id="facultyStats">
      Loading faculty list...
    </div>

    <div class="selection-container">
      <!-- Dropdown Method -->
      <div>
        <label for="facultySelect">Select from Dropdown:</label>
        <select id="facultySelect">
          <option value="">-- Select Faculty --</option>
        </select>
      </div>

      <!-- Search Method -->
      <div class="search-container">
        <label for="facultySearch">Search Faculty:</label>
        <input type="text" id="facultySearch" placeholder="Type faculty name to search...">
        <div class="search-results" id="searchResults"></div>
      </div>
    </div>

    <div class="current-faculty" id="currentFacultyDisplay" style="display:none;">
      Currently editing: <span id="currentFacultyName"></span>
    </div>

    <div class="timetable-grid" id="timetableGrid"></div>

    <div style="text-align:center; margin-top:20px;">
      <button class="btn btn-save" id="saveBtn">Save Changes</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="classModal">
    <div class="modal-content">
      <span class="modal-close" id="closeModal">&times;</span>
      <h3>Edit Class</h3>
      <label for="subject">Subject:</label>
      <input type="text" id="subject">
      <label for="classroom">Classroom:</label>
      <input type="text" id="classroom">
      <div style="margin-top:10px; text-align:right;">
        <button class="btn btn-delete" id="deleteModal">Delete</button>
        <button class="btn btn-save" id="saveModal">Save</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js';

    const SUPABASE_URL = 'https://ucihhvycupjjkmazpfby.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjaWhodnljdXBqamttYXpwZmJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxODQ5MjcsImV4cCI6MjA3Mzc2MDkyN30.XeWpXOmiZS1Z8ejDfnNZ89NiIBoDKTgogOeNDg-Rv8A';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const facultySelect = document.getElementById('facultySelect');
    const facultySearch = document.getElementById('facultySearch');
    const searchResults = document.getElementById('searchResults');
    const facultyStats = document.getElementById('facultyStats');
    const currentFacultyDisplay = document.getElementById('currentFacultyDisplay');
    const currentFacultyName = document.getElementById('currentFacultyName');
    const timetableGrid = document.getElementById('timetableGrid');
    const saveBtn = document.getElementById('saveBtn');
    const classModal = document.getElementById('classModal');
    const subjectInput = document.getElementById('subject');
    const classroomInput = document.getElementById('classroom');
    const saveModal = document.getElementById('saveModal');
    const deleteModal = document.getElementById('deleteModal');
    const closeModal = document.getElementById('closeModal');

    let currentFaculty = null;
    let timetableData = [];
    let currentCell = null;
    let allFaculty = [];

    const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

    // Build empty grid (Periods → columns, Days → rows)
    function buildGrid() {
      timetableGrid.innerHTML = `
        <div class="grid-header">Day/Period</div>
        ${[1,2,3,4,5,6].map(p => `<div class="grid-header">Period ${p}</div>`).join('')}
      `;
      for (let d = 1; d <= 6; d++) {
        timetableGrid.innerHTML += `<div class="row-label">${days[d-1]}</div>`;
        for (let p = 1; p <= 6; p++) {
          timetableGrid.innerHTML += `
            <div class="grid-cell leisure" data-day="${d}" data-period="${p}">
              <button class="delete-btn">×</button>
            </div>`;
        }
      }
    }

    // Function to fetch ALL records with pagination
    async function fetchAllRecords() {
      let allRecords = [];
      let page = 0;
      const pageSize = 1000; // Supabase's max limit
      let hasMore = true;

      facultyStats.innerHTML = '<span class="loading">Loading records... (0)</span>';

      while (hasMore) {
        const from = page * pageSize;
        const to = from + pageSize - 1;
        
        console.log(`Fetching records ${from} to ${to}...`);
        
        const { data, error, count } = await supabase
          .from('timetable')
          .select('*', { count: 'exact' })
          .range(from, to);

        if (error) {
          console.error('Error fetching page:', error);
          throw error;
        }

        if (data && data.length > 0) {
          allRecords = allRecords.concat(data);
          facultyStats.innerHTML = `<span class="loading">Loading records... (${allRecords.length})</span>`;
        }

        // Check if we have more records to fetch
        hasMore = data && data.length === pageSize;
        page++;

        // Add a small delay to avoid rate limiting
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      console.log(`Total records fetched: ${allRecords.length}`);
      return allRecords;
    }

    // Load all faculty list with pagination
    async function loadAllFaculty() {
      try {
        facultyStats.innerHTML = '<span class="loading">Starting to load all records...</span>';
        
        // Fetch ALL records with pagination
        const allRecords = await fetchAllRecords();
        
        facultyStats.innerHTML = '<span class="loading">Processing faculty data...</span>';

        // Process all records to get unique faculty
        const facultyMap = {};
        let validRecords = 0;

        allRecords.forEach(record => {
          // Very lenient filtering - only exclude truly null/undefined
          if (record.faculty_name == null) {
            return;
          }
          
          const cleanName = String(record.faculty_name).trim();
          
          // Only exclude completely empty strings after trim
          if (cleanName === '') {
            return;
          }
          
          validRecords++;

          if (!facultyMap[cleanName]) {
            facultyMap[cleanName] = {
              name: cleanName,
              total: 0,
              teaching: 0,
              free: 0
            };
          }
          
          facultyMap[cleanName].total++;
          if (!record.is_leisure) {
            facultyMap[cleanName].teaching++;
          } else {
            facultyMap[cleanName].free++;
          }
        });

        allFaculty = Object.values(facultyMap).sort((a, b) => a.name.localeCompare(b.name));

        // Update stats
        facultyStats.innerHTML = `
          <strong>Total Faculty Members: ${allFaculty.length}</strong>
          <br><small>Processed ${validRecords} of ${allRecords.length} total database records</small>
          ${allFaculty.length !== 47 ? 
            `<br><small style="color: orange;">Expected: 47 | Found: ${allFaculty.length}</small>` : 
            `<br><small style="color: green;">✓ All 47 faculty members loaded successfully!</small>`
          }
        `;
        
        // Populate dropdown
        facultySelect.innerHTML = '<option value="">-- Select Faculty --</option>' +
          allFaculty.map(faculty => 
            `<option value="${faculty.name}">${faculty.name}</option>`
          ).join('');

        console.log('Final faculty processing complete:', {
          totalRecords: allRecords.length,
          validRecords: validRecords,
          facultyCount: allFaculty.length,
          facultyList: allFaculty.map(f => ({
            name: f.name,
            totalEntries: f.total,
            teaching: f.teaching,
            free: f.free
          }))
        });

        // If we still don't have 47, show debug info
        if (allFaculty.length !== 47) {
          console.warn('Missing faculty members. All records sample:', allRecords.slice(0, 10));
          await debugFacultyData(allRecords);
        }

      } catch (error) {
        console.error('Error loading faculty:', error);
        facultyStats.innerHTML = `Error loading faculty list: ${error.message}`;
      }
    }

    // Debug function to analyze faculty data
    async function debugFacultyData(allRecords) {
      console.group('Faculty Data Debug Info');
      
      // Get all unique faculty names with counts
      const allFacultyNames = allRecords
        .map(r => r.faculty_name)
        .filter(name => name != null)
        .map(name => String(name).trim())
        .filter(name => name !== '');
      
      const uniqueNames = [...new Set(allFacultyNames)];
      
      console.log('All unique faculty names found:', uniqueNames);
      console.log('Total unique names:', uniqueNames.length);
      
      // Show names that might be filtered out
      const problematicNames = allRecords
        .map(r => r.faculty_name)
        .filter(name => name == null || String(name).trim() === '');
      
      console.log('Problematic/Filtered names:', problematicNames);
      console.log('Count of problematic names:', problematicNames.length);
      
      console.groupEnd();
      
      // Update stats with debug info
      facultyStats.innerHTML += `
        <br><small style="color: red;">Debug: Found ${uniqueNames.length} unique names in raw data</small>
      `;
    }

    // Search faculty function
    function searchFaculty(query) {
      if (!query) {
        searchResults.style.display = 'none';
        return;
      }
      
      const filtered = allFaculty.filter(faculty => 
        faculty.name.toLowerCase().includes(query.toLowerCase())
      );
      
      if (filtered.length === 0) {
        searchResults.innerHTML = '<div class="search-result-item">No faculty found</div>';
      } else {
        searchResults.innerHTML = filtered.map(faculty => 
          `<div class="search-result-item" data-faculty="${faculty.name}">
            <strong>${faculty.name}</strong>
            <br><small>Teaching: ${faculty.teaching} periods | Free: ${faculty.free} periods</small>
          </div>`
        ).join('');
      }
      searchResults.style.display = 'block';
    }

    // Load timetable for selected faculty
    async function loadFacultyTimetable(name) {
      if (!name) return;
      
      currentFaculty = name;
      
      // Use pagination to get all timetable entries for this faculty
      let allTimetableEntries = [];
      let page = 0;
      const pageSize = 1000;
      let hasMore = true;

      while (hasMore) {
        const from = page * pageSize;
        const to = from + pageSize - 1;
        
        const { data, error } = await supabase
          .from('timetable')
          .select('*')
          .eq('faculty_name', name)
          .range(from, to);

        if (error) { 
          console.error(error); 
          alert('Error loading timetable: ' + error.message);
          return; 
        }

        if (data && data.length > 0) {
          allTimetableEntries = allTimetableEntries.concat(data);
        }

        hasMore = data && data.length === pageSize;
        page++;
      }

      // If no data exists for this faculty, create empty entries
      if (allTimetableEntries.length === 0) {
        timetableData = [];
        for (let day = 1; day <= 6; day++) {
          for (let period = 1; period <= 6; period++) {
            timetableData.push({
              faculty_name: name,
              day_id: day,
              period_id: period,
              is_leisure: true,
              subject: null,
              classroom: null,
              is_active: true
            });
          }
        }
      } else {
        timetableData = allTimetableEntries.map(d => ({ ...d }));
      }
      
      renderTimetable();
      
      // Update current faculty display
      currentFacultyName.textContent = name;
      currentFacultyDisplay.style.display = 'block';
      
      // Clear search and close results
      facultySearch.value = '';
      searchResults.style.display = 'none';
      
      // Update dropdown selection
      facultySelect.value = name;
    }

    // Render timetable
    function renderTimetable() {
      buildGrid();
      timetableData.forEach(entry => {
        const cell = timetableGrid.querySelector(`.grid-cell[data-day="${entry.day_id}"][data-period="${entry.period_id}"]`);
        if (!entry.is_leisure && entry.subject) {
          cell.classList.add('class');
          cell.classList.remove('leisure');
          cell.innerHTML = `
            <strong>${entry.subject}</strong>
            <br>${entry.classroom || ''}
            <button class="delete-btn">×</button>
          `;
        }
      });

      // Add delete listeners for grid cells
      timetableGrid.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const cell = btn.parentElement;
          const day = cell.dataset.day;
          const period = cell.dataset.period;
          const entry = timetableData.find(x => x.day_id == day && x.period_id == period);
          if (entry) {
            entry.subject = null;
            entry.classroom = null;
            entry.is_leisure = true;
            renderTimetable();
          }
        });
      });
    }

    // Event Listeners

    // Dropdown selection
    facultySelect.addEventListener('change', e => {
      loadFacultyTimetable(e.target.value);
    });

    // Search input
    facultySearch.addEventListener('input', e => {
      searchFaculty(e.target.value);
    });

    // Search result click
    searchResults.addEventListener('click', e => {
      if (e.target.classList.contains('search-result-item')) {
        const facultyName = e.target.dataset.faculty;
        loadFacultyTimetable(facultyName);
      }
    });

    // Hide search results when clicking outside
    document.addEventListener('click', e => {
      if (!facultySearch.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = 'none';
      }
    });

    // Cell click → open modal
    timetableGrid.addEventListener('click', e => {
      if (!currentFaculty) {
        alert('Please select a faculty first');
        return;
      }
      
      if (!e.target.classList.contains('grid-cell')) return;
      currentCell = e.target;
      const day = currentCell.dataset.day;
      const period = currentCell.dataset.period;
      const entry = timetableData.find(x => x.day_id == day && x.period_id == period);
      subjectInput.value = entry?.subject || '';
      classroomInput.value = entry?.classroom || '';
      classModal.style.display = 'flex';
    });

    // Save in modal
    saveModal.addEventListener('click', () => {
      if (!currentCell || !currentFaculty) return;
      const day = currentCell.dataset.day;
      const period = currentCell.dataset.period;
      const entry = timetableData.find(x => x.day_id == day && x.period_id == period);
      if (entry) {
        entry.subject = subjectInput.value.trim();
        entry.classroom = entry.subject ? classroomInput.value.trim() : null;
        entry.is_leisure = entry.subject === '';
        renderTimetable();
        classModal.style.display = 'none';
      }
    });

    // Delete in modal
    deleteModal.addEventListener('click', () => {
      if (!currentCell || !currentFaculty) return;
      const day = currentCell.dataset.day;
      const period = currentCell.dataset.period;
      const entry = timetableData.find(x => x.day_id == day && x.period_id == period);
      if (entry) {
        entry.subject = null;
        entry.classroom = null;
        entry.is_leisure = true;
        renderTimetable();
        classModal.style.display = 'none';
      }
    });

    // Close modal (X button)
    closeModal.addEventListener('click', () => {
      classModal.style.display = 'none';
    });

    // Close modal when clicking outside content
    window.addEventListener('click', (e) => {
      if (e.target === classModal) {
        classModal.style.display = 'none';
      }
    });

    // Save to DB
    saveBtn.addEventListener('click', async () => {
      if (!currentFaculty) { 
        alert('Please select a faculty first'); 
        return; 
      }
      
      const rows = timetableData.map(item => ({
        faculty_name: item.faculty_name,
        day_id: item.day_id,
        period_id: item.period_id,
        subject: item.is_leisure ? null : item.subject,
        classroom: item.is_leisure ? null : item.classroom,
        is_leisure: item.is_leisure,
        is_active: true,
        updated_at: new Date().toISOString()
      }));
      
      const { error } = await supabase
        .from('timetable')
        .upsert(rows, { 
          onConflict: ['faculty_name','day_id','period_id'] 
        });
      
      if (error) {
        alert('Error saving: ' + error.message);
        console.error(error);
      } else {
        alert('Timetable updated successfully!');
      }
    });

    // Initialize
    buildGrid();
    loadAllFaculty();
  </script>
</body>
</html>
