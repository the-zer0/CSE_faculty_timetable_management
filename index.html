<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Faculty Class Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f5f7fa; padding: 20px; color: #333; }

    .container { max-width: 1200px; margin: auto; }

    header { text-align: center; margin-bottom: 30px; }
    header h1 { font-size: 1.8rem; color: #2c3e50; margin-bottom: 10px; }
    header p { color: #7f8c8d; }

    .period-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }

    .period-card h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 8px;
      color: #2c3e50;
    }

    .period-inner {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .sub-card {
      background: #fafafa;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .sub-card h3 {
      font-size: 1rem;
      margin-bottom: 10px;
      color: #34495e;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eaeaea; }
    th { background: #f8f9fa; font-weight: 600; color: #2c3e50; }

    .status-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }

    .status-teaching { background: #e8f5e9; color: #27ae60; }
    .status-free { background: #fdedec; color: #e74c3c; }

    @media (max-width: 768px) {
      .period-inner { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ“š Faculty Class Dashboard</h1>
      <p id="datetime">Loading date & time...</p>
    </header>

    <!-- Current Period -->
    <div class="period-card">
      <h2>Current Period</h2>
      <div class="period-inner">
        <div class="sub-card">
          <h3>Teaching</h3>
          <table id="current-teaching">
            <thead>
              <tr><th>Faculty</th><th>Subject</th><th>Classroom</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="sub-card">
          <h3>Free Faculty</h3>
          <table id="current-free">
            <thead>
              <tr><th>Faculty</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Next Period -->
    <div class="period-card">
      <h2>Next Period</h2>
      <div class="period-inner">
        <div class="sub-card">
          <h3>Teaching</h3>
          <table id="next-teaching">
            <thead>
              <tr><th>Faculty</th><th>Subject</th><th>Classroom</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="sub-card">
          <h3>Free Faculty</h3>
          <table id="next-free">
            <thead>
              <tr><th>Faculty</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://esm.sh/@supabase/supabase-js"></script>
 <script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

// ---------------- Supabase Configuration ----------------
const SUPABASE_URL = "https://ucihhvycupjjkmazpfby.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjaWhodnljdXBqamttYXpwZmJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxODQ5MjcsImV4cCI6MjA3Mzc2MDkyN30.XeWpXOmiZS1Z8ejDfnNZ89NiIBoDKTgogOeNDg-Rv8A";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ---------------- DOM Elements ----------------
const currentDateElement = document.getElementById("datetime");

const currentTeachingTable = document.getElementById("current-teaching").querySelector("tbody");
const currentFreeTable = document.getElementById("current-free").querySelector("tbody");

const nextTeachingTable = document.getElementById("next-teaching").querySelector("tbody");
const nextFreeTable = document.getElementById("next-free").querySelector("tbody");

// ---------------- Period Schedule ----------------
const periodSchedule = [
  { id: 1, start: "09:20", end: "10:20" },
  { id: 2, start: "10:20", end: "11:20" },
  { id: 3, start: "11:20", end: "12:20" },
  { id: 4, start: "13:10", end: "14:10" },
  { id: 5, start: "14:10", end: "15:10" },
  { id: 6, start: "15:10", end: "16:10" },
];

// ---------------- Utilities ----------------
function updateDateTime() {
  const now = new Date();
  const options = {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
  };
  currentDateElement.textContent = now.toLocaleDateString("en-US", options);
}

function clearTable(tableBody) {
  tableBody.innerHTML = "";
}

function insertRow(tableBody, columns) {
  const row = document.createElement("tr");
  columns.forEach((col) => {
    const td = document.createElement("td");
    td.textContent = col;
    row.appendChild(td);
  });
  tableBody.appendChild(row);
}

// ---------------- Period Finder ----------------
function getCurrentDayAndPeriod() {
  const now = new Date();
  const currentDay = now.getDay(); // 0 = Sunday, 1 = Monday, ...
  const currentTime = now.toTimeString().substring(0, 5);

  let dbDay = currentDay;
  if (dbDay === 0) dbDay = 7; // Sunday -> 7

  let currentPeriod = null;
  for (const period of periodSchedule) {
    if (currentTime >= period.start && currentTime < period.end) {
      currentPeriod = period.id;
      break;
    }
  }

  return { day: dbDay, period: currentPeriod };
}

// ---------------- Fetch Timetable ----------------
async function getTimetable(day, period) {
  const { data, error } = await supabase
    .from("timetable")
    .select("*")
    .eq("day_id", day)
    .eq("period_id", period)
    .eq("is_active", true);

  if (error) {
    console.error("Supabase error:", error);
    return [];
  }

  return data || [];
}

// ---------------- Update Dashboard ----------------
async function updateDashboard() {
  const { day, period } = getCurrentDayAndPeriod();
  if (!period || day > 6) {
    clearTable(currentTeachingTable);
    clearTable(currentFreeTable);
    clearTable(nextTeachingTable);
    clearTable(nextFreeTable);

    insertRow(currentTeachingTable, ["-", "-", "-", "No session"]);
    insertRow(currentFreeTable, ["-", "No session"]);
    insertRow(nextTeachingTable, ["-", "-", "-", "No session"]);
    insertRow(nextFreeTable, ["-", "No session"]);
    return;
  }

  // Current Period
  const currentData = await getTimetable(day, period);
  const facultyNames = [...new Set(currentData.map((f) => f.faculty_name))];

  clearTable(currentTeachingTable);
  clearTable(currentFreeTable);

  facultyNames.forEach((name) => {
    const entries = currentData.filter((f) => f.faculty_name === name);
    const isTeaching = entries.some((e) => !e.is_leisure);

    if (isTeaching) {
      const entry = entries.find((e) => !e.is_leisure);
      insertRow(currentTeachingTable, [name, entry.subject, entry.classroom, "Teaching"]);
    } else {
      insertRow(currentFreeTable, [name, "Free"]);
    }
  });

  // Next Period
  const nextPeriod = period + 1;
  const nextData = await getTimetable(day, nextPeriod);
  const nextNames = [...new Set(nextData.map((f) => f.faculty_name))];

  clearTable(nextTeachingTable);
  clearTable(nextFreeTable);

  nextNames.forEach((name) => {
    const entries = nextData.filter((f) => f.faculty_name === name);
    const isTeaching = entries.some((e) => !e.is_leisure);

    if (isTeaching) {
      const entry = entries.find((e) => !e.is_leisure);
      insertRow(nextTeachingTable, [name, entry.subject, entry.classroom, "Teaching"]);
    } else {
      insertRow(nextFreeTable, [name, "Free"]);
    }
  });
}

// ---------------- Auto Refresh ----------------
document.addEventListener("DOMContentLoaded", () => {
  updateDateTime();
  setInterval(updateDateTime, 1000);

  updateDashboard();
  setInterval(updateDashboard, 60000);
});
</script>



</body>
</html>
