<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Faculty Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eaeaea;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
    h2 {
      color: #2c3e50;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #3498db;
    }
    #current-date {
      color: #7f8c8d;
      font-size: 1.1em;
    }
    .table-container {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eaeaea;
    }
    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
    }
    tr:hover {
      background-color: #f5f7fa;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }
    select, input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    .btn {
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn:hover {
      background-color: #2980b9;
    }
    footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eaeaea;
      color: #7f8c8d;
    }
    .status-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }
    .status-teaching {
      background-color: #e8f5e9;
      color: #27ae60;
    }
    .status-free {
      background-color: #fdedec;
      color: #e74c3c;
    }
    @media (max-width: 768px) {
      form {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ“š Faculty Class Dashboard</h1>
      <p id="current-date"></p>
    </header>
    
    <main>
      <!-- ðŸ“Œ Live Dashboard -->
      <section>
        <h2>Ongoing Classes</h2>
        <div class="table-container" id="dashboard">
          <p class="loading">Loading timetable...</p>
        </div>
        
        <h2>Free / Leisure Faculty</h2>
        <div class="table-container" id="leisure-dashboard">
          <p class="loading">Loading leisure data...</p>
        </div>
      </section>
      
      <!-- ðŸ“Œ Leisure Finder -->
      <section>
        <button id="toggle-filter" type="button" class="btn">Show Leisure Finder</button>
        
        <form id="leisure-form" style="display:none; margin-top:1rem;" class="card">
          <div>
            <label for="day">Day:</label>
            <select id="day" name="day" required>
              <option value="">--Select Day--</option>
              <option value="1">Monday</option>
              <option value="2">Tuesday</option>
              <option value="3">Wednesday</option>
              <option value="4">Thursday</option>
              <option value="5">Friday</option>
              <option value="6">Saturday</option>
            </select>
          </div>
          
          <div>
            <label for="period">Period:</label>
            <select id="period" name="period" required>
              <option value="">--Select Period--</option>
              <option value="1">Period 1</option>
              <option value="2">Period 2</option>
              <option value="3">Period 3</option>
              <option value="4">Period 4</option>
              <option value="5">Period 5</option>
              <option value="6">Period 6</option>
            </select>
          </div>
          
          <div>
            <button type="submit" class="btn">Find Leisure Faculty</button>
          </div>
        </form>
        
        <div id="leisure-results" class="table-container" style="margin-top:1rem;"></div>
      </section>
    </main>
    
    <footer>
      <p>&copy; 2025 Faculty Dashboard</p>
    </footer>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js';
    
    // Supabase configuration
    const SUPABASE_URL = 'https://ucihhvycupjjkmazpfby.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjaWhodnljdXBqamttYXpwZmJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxODQ5MjcsImV4cCI6MjA3Mzc2MDkyN30.XeWpXOmiZS1Z8ejDfnNZ89NiIBoDKTgogOeNDg-Rv8A';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    
    // DOM elements
    const currentDateElement = document.getElementById('current-date');
    const dashboardElement = document.getElementById('dashboard');
    const leisureDashboardElement = document.getElementById('leisure-dashboard');
    const toggleFilterButton = document.getElementById('toggle-filter');
    const leisureForm = document.getElementById('leisure-form');
    const leisureResultsElement = document.getElementById('leisure-results');
    
    // Period schedule
    const periodSchedule = [
      { id: 1, start: '09:20', end: '10:20' },
      { id: 2, start: '10:20', end: '11:20' },
      { id: 3, start: '11:20', end: '12:20' },
      { id: 4, start: '13:10', end: '14:10' },
      { id: 5, start: '14:10', end: '15:10' },
      { id: 6, start: '15:10', end: '16:10' }
    ];
    
    // Initialize the dashboard
    function initDashboard() {
      updateDateTime();
      updateDashboard();
      
      // Update time every second
      setInterval(updateDateTime, 1000);
      
      // Update dashboard every minute
      setInterval(updateDashboard, 60000);
      
      // Set up event listeners
      toggleFilterButton.addEventListener('click', () => {
        const isVisible = leisureForm.style.display === 'block';
        leisureForm.style.display = isVisible ? 'none' : 'block';
        toggleFilterButton.textContent = isVisible ? 'Show Leisure Finder' : 'Hide Leisure Finder';
      });
      
      leisureForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const day = document.getElementById('day').value;
        const period = document.getElementById('period').value;
        
        if (day && period) {
          await findLeisureFaculty(day, period);
        }
      });
    }
    
    // Update date and time display
    function updateDateTime() {
      const now = new Date();
      currentDateElement.textContent = now.toLocaleDateString('en-US', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
      }) + ' | ' + now.toLocaleTimeString('en-US', { 
        hour: '2-digit', minute: '2-digit', second: '2-digit' 
      });
    }
    
    // Get current day and period based on time
    function getCurrentDayAndPeriod() {
      const now = new Date();
      const currentDay = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
      const currentTime = now.toTimeString().substring(0, 5); // HH:MM format
      
      let dbDay = currentDay;
      if (dbDay === 0) dbDay = 7; // Sunday is not a teaching day
      
      let currentPeriod = null;
      for (const period of periodSchedule) {
        if (currentTime >= period.start && currentTime < period.end) {
          currentPeriod = period.id;
          break;
        }
      }
      
      return { day: dbDay, period: currentPeriod, time: currentTime };
    }
    
    // Update the main dashboard
    async function updateDashboard() {
      try {
        const { day, period } = getCurrentDayAndPeriod();
        
        if (!period || day > 6) {
          dashboardElement.innerHTML = `<p class="loading">No teaching sessions at this time</p>`;
          leisureDashboardElement.innerHTML = `<p class="loading">No teaching sessions at this time</p>`;
          return;
        }
        
        // Fetch active timetable entries
        const { data, error } = await supabase
          .from('timetable')
          .select('*')
          .eq('day_id', day)
          .eq('period_id', period)
          .eq('is_active', true);   // âœ… only active
        
        if (error) {
          console.error('Error fetching data:', error);
          dashboardElement.innerHTML = '<p class="loading">Error loading data</p>';
          leisureDashboardElement.innerHTML = '<p class="loading">Error loading data</p>';
          return;
        }
        
        const teachingTeachers = [];
        const freeTeachers = [];
        
        const facultyNames = [...new Set(data.map(item => item.faculty_name))];
        
        for (const name of facultyNames) {
          const facultyEntries = data.filter(item => item.faculty_name === name);
          const isTeaching = facultyEntries.some(entry => !entry.is_leisure);
          
          if (isTeaching) {
            const teachingEntry = facultyEntries.find(entry => !entry.is_leisure);
            teachingTeachers.push({
              name: name,
              subject: teachingEntry.subject,
              classroom: teachingEntry.classroom
            });
          } else {
            freeTeachers.push({ name: name });
          }
        }
        
        updateTeachingTable(teachingTeachers);
        updateFreeTable(freeTeachers);
        
      } catch (error) {
        console.error('Error:', error);
        dashboardElement.innerHTML = '<p class="loading">Error loading data</p>';
        leisureDashboardElement.innerHTML = '<p class="loading">Error loading data</p>';
      }
    }
    
    function updateTeachingTable(teachers) {
      if (teachers.length > 0) {
        dashboardElement.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Faculty Name</th>
                <th>Subject</th>
                <th>Classroom</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${teachers.map(teacher => `
                <tr>
                  <td>${teacher.name}</td>
                  <td>${teacher.subject}</td>
                  <td>${teacher.classroom}</td>
                  <td><span class="status-badge status-teaching">Teaching</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } else {
        dashboardElement.innerHTML = `<p class="loading">No teachers are currently teaching</p>`;
      }
    }
    
    function updateFreeTable(teachers) {
      if (teachers.length > 0) {
        leisureDashboardElement.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Faculty Name</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${teachers.map(teacher => `
                <tr>
                  <td>${teacher.name}</td>
                  <td><span class="status-badge status-free">Free</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } else {
        leisureDashboardElement.innerHTML = `<p class="loading">No teachers are currently free</p>`;
      }
    }
    
    // Leisure finder
    async function findLeisureFaculty(day, period) {
      try {
        leisureResultsElement.innerHTML = '<p class="loading">Searching...</p>';
        
        const { data, error } = await supabase
          .from('timetable')
          .select('*')
          .eq('day_id', day)
          .eq('period_id', period)
          .eq('is_active', true);   // âœ… only active
        
        if (error) {
          console.error('Error fetching data:', error);
          leisureResultsElement.innerHTML = '<p class="loading">Error loading data</p>';
          return;
        }
        
        const leisureFaculty = [];
        const facultyNames = [...new Set(data.map(item => item.faculty_name))];
        
        for (const name of facultyNames) {
          const facultyEntries = data.filter(item => item.faculty_name === name);
          const isFree = facultyEntries.every(entry => entry.is_leisure);
          
          if (isFree) {
            leisureFaculty.push({ name: name });
          }
        }
        
        if (leisureFaculty.length > 0) {
          const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
          leisureResultsElement.innerHTML = `
            <h3>Faculty Free on ${dayNames[day-1]} during Period ${period}</h3>
            <table>
              <thead>
                <tr>
                  <th>Faculty Name</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${leisureFaculty.map(teacher => `
                  <tr>
                    <td>${teacher.name}</td>
                    <td><span class="status-badge status-free">Free</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          leisureResultsElement.innerHTML = `<p class="loading">No faculty members are free at the selected time</p>`;
        }
        
      } catch (error) {
        console.error('Error:', error);
        leisureResultsElement.innerHTML = '<p class="loading">Error loading data</p>';
      }
    }
    
    initDashboard();
  </script>
</body>
</html>
