<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="faculty_dashboard_logo.png">
  <title>Faculty Class Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f5f7fa; padding: 20px; color: #333; }

    .container { max-width: 1200px; margin: auto; }

    header { text-align: center; margin-bottom: 30px; }
    header h1 { font-size: 1.8rem; color: #2c3e50; margin-bottom: 10px; }
    header p { color: #7f8c8d; }

    .period-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }

    .period-card h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 8px;
      color: #2c3e50;
    }

    .period-inner {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .sub-card {
      background: #fafafa;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .sub-card h3 {
      font-size: 1rem;
      margin-bottom: 10px;
      color: #34495e;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eaeaea; }
    th { background: #f8f9fa; font-weight: 600; color: #2c3e50; }

    .status-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }

    .status-teaching { background: #e8f5e9; color: #27ae60; }
    .status-free { background: #fdedec; color: #e74c3c; }

    .leisure-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }

    .leisure-card h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      border-bottom: 2px solid #27ae60;
      padding-bottom: 8px;
      color: #2c3e50;
    }

    form { margin-bottom: 15px; }
    select, button {
      padding: 8px 12px;
      margin-right: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    button {
      background: #3498db;
      color: #fff;
      cursor: pointer;
      border: none;
    }
    button:hover { background: #2980b9; }

    @media (max-width: 768px) {
      .period-inner { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ“š Faculty Class Dashboard</h1>
      <p id="datetime">Loading date & time...</p>
    </header>

    <!-- Current Period -->
    <div class="period-card">
      <h2>Current Period</h2>
      <div class="period-inner">
        <div class="sub-card">
          <h3>Teaching</h3>
          <table id="current-teaching">
            <thead>
              <tr><th>Faculty</th><th>Subject</th><th>Classroom</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="sub-card">
          <h3>Free Faculty</h3>
          <table id="current-free">
            <thead>
              <tr><th>Faculty</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Next Period -->
    <div class="period-card">
      <h2>Next Period</h2>
      <div class="period-inner">
        <div class="sub-card">
          <h3>Teaching</h3>
          <table id="next-teaching">
            <thead>
              <tr><th>Faculty</th><th>Subject</th><th>Classroom</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="sub-card">
          <h3>Free Faculty</h3>
          <table id="next-free">
            <thead>
              <tr><th>Faculty</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Leisure Finder -->
    <div class="leisure-card">
      <h2>ðŸŽ¯ Leisure Finder</h2>
      <form id="leisure-form">
        <label for="day">Day:</label>
        <select id="day">
          <option value="1">Monday</option>
          <option value="2">Tuesday</option>
          <option value="3">Wednesday</option>
          <option value="4">Thursday</option>
          <option value="5">Friday</option>
          <option value="6">Saturday</option>
        </select>

        <label for="period">Period:</label>
        <select id="period">
          <option value="1">Period 1</option>
          <option value="2">Period 2</option>
          <option value="3">Period 3</option>
          <option value="4">Period 4</option>
          <option value="5">Period 5</option>
          <option value="6">Period 6</option>
        </select>

        <button type="submit">Find Free Faculty</button>
      </form>

      <div id="leisure-results">
        <p>Select a day and period to search free faculty.</p>
      </div>
    </div>
  </div>

  <!-- Supabase + Script -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const SUPABASE_URL = "https://ucihhvycupjjkmazpfby.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjaWhodnljdXBqamttYXpwZmJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxODQ5MjcsImV4cCI6MjA3Mzc2MDkyN30.XeWpXOmiZS1Z8ejDfnNZ89NiIBoDKTgogOeNDg-Rv8A";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM Elements
    const datetimeEl = document.getElementById("datetime");

    const currentTeachingBody = document.querySelector("#current-teaching tbody");
    const currentFreeBody = document.querySelector("#current-free tbody");
    const nextTeachingBody = document.querySelector("#next-teaching tbody");
    const nextFreeBody = document.querySelector("#next-free tbody");

    const leisureForm = document.getElementById("leisure-form");
    const leisureResults = document.getElementById("leisure-results");

    // Periods
    const periodSchedule = [
      { id: 1, start: "09:20", end: "10:20" },
      { id: 2, start: "10:20", end: "11:20" },
      { id: 3, start: "11:20", end: "12:20" },
      { id: 4, start: "13:10", end: "14:10" },
      { id: 5, start: "14:10", end: "15:10" },
      { id: 6, start: "15:10", end: "16:10" }
    ];

    // Utils
    function updateDateTime() {
      const now = new Date();
      datetimeEl.textContent =
        now.toLocaleDateString("en-US", { weekday: "long", year: "numeric", month: "long", day: "numeric" }) +
        " | " +
        now.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    function clearTable(tbody) { tbody.innerHTML = ""; }
    function addRow(tbody, cols) {
      const tr = document.createElement("tr");
      cols.forEach(c => {
        const td = document.createElement("td");
        td.textContent = c;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }

    function getCurrentDayAndPeriod() {
      const now = new Date();
      let day = now.getDay();
      if (day === 0) day = 7;
      const time = now.toTimeString().substring(0,5);

      let currentPeriod = null;
      for (const p of periodSchedule) {
        if (time >= p.start && time < p.end) { currentPeriod = p.id; break; }
      }
      return { day, period: currentPeriod };
    }

    async function fetchTimetable(day, period) {
      const { data, error } = await supabase
        .from("timetable")
        .select("*")
        .eq("day_id", day)
        .eq("period_id", period)
        .eq("is_active", true);

      if (error) { console.error(error); return []; }
      return data || [];
    }

    async function updateDashboard() {
      const { day, period } = getCurrentDayAndPeriod();
      if (!period || day > 6) return;

      // Current
      const currentData = await fetchTimetable(day, period);
      renderData(currentData, currentTeachingBody, currentFreeBody);

      // Next
      const nextData = await fetchTimetable(day, period+1);
      renderData(nextData, nextTeachingBody, nextFreeBody);
    }

    function renderData(data, teachingBody, freeBody) {
      clearTable(teachingBody);
      clearTable(freeBody);

      const facultyNames = [...new Set(data.map(d => d.faculty_name))];

      facultyNames.forEach(name => {
        const entries = data.filter(d => d.faculty_name === name);
        const isTeaching = entries.some(e => !e.is_leisure);

        if (isTeaching) {
          const entry = entries.find(e => !e.is_leisure);
          addRow(teachingBody, [name, entry.subject, entry.classroom, "Teaching"]);
        } else {
          addRow(freeBody, [name, "Free"]);
        }
      });
    }

    // Leisure Finder
    leisureForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const day = document.getElementById("day").value;
      const period = document.getElementById("period").value;

      leisureResults.innerHTML = "<p>Loading...</p>";
      const data = await fetchTimetable(day, period);

      const freeFaculty = [];
      const names = [...new Set(data.map(d => d.faculty_name))];

      names.forEach(name => {
        const entries = data.filter(d => d.faculty_name === name);
        const isFree = entries.every(e => e.is_leisure);
        if (isFree) freeFaculty.push(name);
      });

      if (freeFaculty.length > 0) {
        leisureResults.innerHTML = `
          <table>
            <thead><tr><th>Faculty</th><th>Status</th></tr></thead>
            <tbody>
              ${freeFaculty.map(n => `<tr><td>${n}</td><td><span class="status-badge status-free">Free</span></td></tr>`).join("")}
            </tbody>
          </table>`;
      } else {
        leisureResults.innerHTML = "<p>No faculty free at this time.</p>";
      }
    });

    // Init
    updateDateTime();
    setInterval(updateDateTime, 1000);
    updateDashboard();
    setInterval(updateDashboard, 60000);
  </script>
</body>
</html>
